SUBROUTINE JSL.TOPS.XTR.TTL

*============================================
* Title: BI Teller Data Extraction
* Initial Author: Yisau Ramon ; For Tops Analytics
* Date: 1st May 2018
*============================================

$INSERT I_COMMON
$INSERT I_EQUATE
$INSERT I_F.TELLER
$INSERT I_F.DATES
$INSERT I_F.COMPANY
$INSERT I_F.TELLER.ID
$INSERT I_F.INTERCO.PARAMETER

GOSUB INIT
GOSUB PROCESS
RETURN

INIT:
	FN.INTERCO='F.INTERCO.PARAMETER'
	F.INTERCO=''
	CALL OPF(FN.INTERCO,F.INTERCO)
   LWORK.DATE=R.DATES(EB.DAT.LAST.WORKING.DAY)
   DB.DATE=TODAY[1,4]:'-':TODAY[5,2]:'-':TODAY[7,2] ; OUT.ARR='' ; R.TT='' ; PY.LIST='' ; DLM='|' ; TT.ID='' ; BRANCH.NAME=''
   REPORT.DATE=R.DATES(EB.DAT.LAST.WORKING.DAY)[1,4]:'-':R.DATES(EB.DAT.LAST.WORKING.DAY)[5,2]:'-':R.DATES(EB.DAT.LAST.WORKING.DAY)[7,2]
   	SYS.ID='SYSTEM' ; API.ID='JSL.TOPS.API' ; V.RESPONSE='' ; RET.ERR=''
	READ R.INTERCO FROM F.INTERCO,SYS.ID ELSE NULL
	MNE.LIST=R.INTERCO<ST.ICP.FIN.MNEMONIC>
RETURN

PROCESS:
   MNE.CNT=DCOUNT(MNE.LIST,@VM)
   FOR J=1 TO MNE.CNT
      MNE=MNE.LIST<1,J>
   FN.TT='F':MNE:'.TELLER'
   F.TT=''
   CALL OPF(FN.TT,F.TT)
   FN.TID='F':MNE:'.TELLER.ID'
   F.TID=''
   CALL OPF(FN.TID,F.TID)
   TT.CMD='SELECT ':FN.TT:' WITH VALUE.DATE.1 EQ ':LWORK.DATE
   CALL EB.READLIST(TT.CMD,TT.LIST,'','','')
   LOOP
   REMOVE TT.ID FROM TT.LIST SETTING TT.POS
        IF TT.POS=0 THEN GOSUB LOAD.DATA
   WHILE TT.ID:TT.POS
   CALL F.READ(FN.TT,TT.ID,R.TT,F.TT,TT.ERR)
   CALL DBR('COMPANY':FM:EB.COM.COMPANY.NAME,R.TT<TT.TE.CO.CODE>,BRANCH.NAME)
   CALL F.READ(FN.TID,R.TT<TT.TE.TELLER.ID.1>,R.TID,F.TID,TID.ERR)
   IF R.TT<TT.TE.EXPOSURE.DATE.1> THEN
   EX.DATE=R.TT<TT.TE.EXPOSURE.DATE.1>[1,4]:'-':R.TT<TT.TE.EXPOSURE.DATE.1>[5,2]:'-':R.TT<TT.TE.EXPOSURE.DATE.1>[7,2]
   END ELSE
   EX.DATE=REPORT.DATE
   END
   V.DATE1=R.TT<TT.TE.VALUE.DATE.1>[1,4]:'-':R.TT<TT.TE.VALUE.DATE.1>[5,2]:'-':R.TT<TT.TE.VALUE.DATE.1>[7,2]
   V.DATE2=R.TT<TT.TE.VALUE.DATE.2>[1,4]:'-':R.TT<TT.TE.VALUE.DATE.2>[5,2]:'-':R.TT<TT.TE.VALUE.DATE.2>[7,2]
   OUT.ARR=TT.ID:DLM:R.TT<TT.TE.TELLER.ID.1>:DLM:R.TT<TT.TE.DR.CR.MARKER>:DLM:R.TT<TT.TE.CURRENCY.1>:DLM:R.TT<TT.TE.ACCOUNT.1>
   OUT.ARR:=DLM:R.TT<TT.TE.CUSTOMER.1>:DLM:R.TT<TT.TE.AMOUNT.LOCAL.1>:DLM:R.TT<TT.TE.AMOUNT.FCY.1>:DLM:V.DATE1
   OUT.ARR:=DLM:EX.DATE:DLM:R.TT<TT.TE.NARRATIVE.1>:DLM:R.TT<TT.TE.CURRENCY.2>:DLM:R.TT<TT.TE.TELLER.ID.2>
   OUT.ARR:=DLM:R.TT<TT.TE.ACCOUNT.2>:DLM:R.TT<TT.TE.CUSTOMER.2>:DLM:R.TT<TT.TE.AMOUNT.LOCAL.2>:DLM:R.TT<TT.TE.AMOUNT.FCY.2>
   OUT.ARR:=DLM:R.TT<TT.TE.NET.AMOUNT>:DLM:V.DATE2:DLM:R.TT<TT.TE.CHEQUE.NUMBER>:DLM:R.TT<TT.TE.CHRG.AMT.LOCAL>
   OUT.ARR:=DLM:R.TT<TT.TE.CHRG.AMT.FCCY>:DLM:R.TID<TT.TID.USER>:DLM:R.TT<TT.TE.TRANSACTION.CODE>:DLM:R.TT<TT.TE.CO.CODE>:DLM:DQUOTE(BRANCH.NAME):DLM:REPORT.DATE:DLM:DB.DATE
   
   	PY.LIST<-1>=OUT.ARR
        CNT=DCOUNT(PY.LIST,@FM)
        IF CNT EQ '20000' THEN
            GOSUB LOAD.DATA
        END
        TT.ID='' ; R.TT=''; OUT.ARR='' ; BRANCH.NAME='' ; V.DATE1='' ; V.DATE2='' ; EX.DATE=''
	REPEAT
        NEXT J
RETURN
LOAD.DATA:
     IF PY.LIST NE '' THEN
     PY.LIST=TRIM(PY.LIST,',','A')
     PY.LIST=TRIM(PY.LIST,"'",'A')
     PY.LIST=TRIM(PY.LIST,"~",'A')
     CHANGE FM TO ',' IN PY.LIST
     REQUEST=PY.LIST:"~TTL"
     CALL EB.CALL.JAVA.API(API.ID,REQUEST,V.RESPONSE,RET.ERR)

     PY.LIST=''
     END
    RETURN
END