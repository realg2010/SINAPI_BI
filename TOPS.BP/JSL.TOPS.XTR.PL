    SUBROUTINE JSL.TOPS.XTR.PL

    $INSERT I_COMMON
    $INSERT I_EQUATE
    $INSERT I_F.DATES
    $INSERT I_F.COMPANY
    $INSERT I_F.RE.STAT.LINE.CONT
    $INSERT I_F.CONSOLIDATE.ASST.LIAB
    $INSERT I_F.CONSOLIDATE.PRFT.LOSS
    $INSERT I_F.INTERCO.PARAMETER

    GOSUB INIT
    GOSUB PROCESS
	RETURN 
	
*----*	
INIT:
*----*


    *FN.RE.STAT.LINE.CONT = 'F.RE.STAT.LINE.CONT'
	*F.RE.STAT.LINE.CONT = ''
    *CALL OPF(FN.RE.STAT.LINE.CONT, F.RE.STAT.LINE.CONT)

    *FN.CONSOLIDATE.PRFT.LOSS = 'F.CONSOLIDATE.PRFT.LOSS'
	*F.CONSOLIDATE.PRFT.LOSS= ''
*    CALL OPF(FN.CONSOLIDATE.PRFT.LOSS, F.CONSOLIDATE.PRFT.LOSS)
      FN.INTERCO='F.INTERCO.PARAMETER'
      F.INTERCO=''
      CALL OPF(FN.INTERCO,F.INTERCO)
	
    DLM='|'
	REPORT.DATE=R.DATES(EB.DAT.LAST.WORKING.DAY)[1,4]:'-':R.DATES(EB.DAT.LAST.WORKING.DAY)[5,2]:'-':R.DATES(EB.DAT.LAST.WORKING.DAY)[7,2]
    DB.DATE=TODAY[1,4]:'-':TODAY[5,2]:'-':TODAY[7,2]
	OPEN "","." TO F.PL ELSE PRINT "CAN NOT OPEN DIRECTORY"
    RETURN

*------*
PROCESS:
*------*

    LINE.LIST = ''
    SE.LIST = ''
    DR.TOTAL = 0
    CR.TOTAL = 0
    OUT.ARR = ''
    CRF.FCY.DR.BAL=0 ; CRF.FCY.CR.BAL=0 ; CRF.FCY.BAL=0
	YR.COMPANY = ID.COMPANY ;*'MW0010001'
	YR.MNE=R.COMPANY(EB.COM.MNEMONIC)
	YR.LCY = R.COMPANY(EB.COM.LOCAL.CURRENCY)
    YR.TDY =R.DATES(EB.DAT.LAST.WORKING.DAY)
    	SYS.ID='SYSTEM'
	READ R.INTERCO FROM F.INTERCO,SYS.ID ELSE NULL
	MNE.LIST=R.INTERCO<ST.ICP.FIN.MNEMONIC>
	GOSUB PROCESS.CPL
    RETURN
 
*-----------*	
PROCESS.CPL:
*-----------*
*DEBUG
        MNE.CNT=DCOUNT(MNE.LIST,@VM)
        FOR J=1 TO MNE.CNT
	MNE=MNE.LIST<1,J>
        FN.RE.STAT.LINE.CONT='F':MNE:'.RE.STAT.LINE.CONT'
        F.RE.STAT.LINE.CONT=''
        CALL OPF(FN.RE.STAT.LINE.CONT, F.RE.STAT.LINE.CONT)
        FN.CONSOLIDATE.PRFT.LOSS = 'F':MNE:'.CONSOLIDATE.PRFT.LOSS'
	F.CONSOLIDATE.PRFT.LOSS= ''
        CALL OPF(FN.CONSOLIDATE.PRFT.LOSS, F.CONSOLIDATE.PRFT.LOSS)
	SEL.CONT = "SSELECT ":FN.RE.STAT.LINE.CONT:" WITH @ID LIKE FDHPL...  AND PRFT.CONSOL.KEY NE ''"
	CALL EB.READLIST(SEL.CONT,LINE.LIST,'','','')

	LOOP
		REMOVE LINE.ID FROM LINE.LIST SETTING PLINEPOS
	WHILE LINE.ID:PLINEPOS

	CALL F.READ(FN.RE.STAT.LINE.CONT, LINE.ID, R.LINE.CONT.REC,F.RE.STAT.LINE.CONT, LINERR)
	CPL.IDS = R.LINE.CONT.REC<RE.SLC.PRFT.CONSOL.KEY>
	CRF.LDS = R.LINE.CONT.REC<RE.SLC.DESC,2>
	CPL.CNT = DCOUNT(R.LINE.CONT.REC<RE.SLC.PRFT.CONSOL.KEY>, @VM)
	FOR YYP = 1 TO CPL.CNT
		CPL.ID = R.LINE.CONT.REC<RE.SLC.PRFT.CONSOL.KEY><1,YYP>
		CALL F.READ(FN.CONSOLIDATE.PRFT.LOSS,CPL.ID,R.CPL.REC,F.CONSOLIDATE.PRFT.LOSS ,CPLERR)
		CRF.ID = CPL.ID
        CRF.CAT=R.CPL.REC<RE.PTL.VARIABLE.1>
		CRF.PROD=R.CPL.REC<RE.PTL.VARIABLE.2>
		CRF.SEC=R.CPL.REC<RE.PTL.VARIABLE.3>
		CRF.DEPT=R.CPL.REC<RE.PTL.VARIABLE.4>
		CRF.RES=R.CPL.REC<RE.PTL.VARIABLE.5>
        *IF R.CPL.REC<RE.PTL.DATE.LAST.UPDATE> # YR.TDY THEN
            CCY.CNT = DCOUNT(R.CPL.REC<RE.PTL.CURRENCY>, @VM)
            FOR IX = 1 TO CCY.CNT
            *--Check for balances before last working day - Add to Opening balance ---*
                CRF.BALMVT = 0 ; CRF.FCYBALMVT=0
                CRF.CCY = R.CPL.REC<RE.PTL.CURRENCY><1,IX>
                CRF.BALDAY = R.CPL.REC<RE.PTL.BALANCE><1,IX>
                CRF.BALYTD = R.CPL.REC<RE.PTL.BALANCE.YTD><1,IX>
                CRF.BALMVT = R.CPL.REC<RE.PTL.DEBIT.MOVEMENT><1,IX>
                CRF.BALMVT += R.CPL.REC<RE.PTL.CREDIT.MOVEMENT><1,IX>
				CRF.FCYBALDAY =R.CPL.REC<RE.PTL.CCY.BALANCE><1,IX>
				CRF.FCYBALYTD = R.CPL.REC<RE.PTL.CCY.BALANCE.YTD><1,IX>
				CRF.FCYBALMVT = R.CPL.REC<RE.PTL.CCY.CREDT.MVE><1,IX>
				CRF.FCYBALMVT += R.CPL.REC<RE.PTL.CCY.DEBIT.MVE><1,IX>
                CRF.BAL = CRF.BALDAY + CRF.BALYTD + CRF.BALMVT
				CRF.FCY.BAL=CRF.FCYBALDAY + CRF.FCYBALYTD + CRF.FCYBALMVT
                CRF.TYPE = FIELD(CPL.ID,'.',2,1)
                CRF.REF = FIELDS(LINE.ID,'.',1,2)
                IF CRF.BAL THEN
                    IF CRF.BAL < 0 THEN
                        CRF.DR.BAL = CRF.BAL
                        *DR.TOTAL += CRF.BAL
						CRF.FCY.DR.BAL=CRF.FCY.BAL
                    END 
                    IF CRF.BAL > 0 THEN
                        CRF.CR.BAL = CRF.BAL
                        *CR.TOTAL += CRF.BAL
						CRF.FCY.CR.BAL=CRF.FCY.BAL
                    END
                    GOSUB WRITE.TO.CRF
                END
            NEXT IX
        *END
		R.CPL.REC=''
	NEXT YYP
	R.LINE.CONT.REC=''
	REPEAT
        NEXT J
	WRITE PY.LIST TO F.PL,'PL.REP.-':DB.DATE:"-.txt"
	RETURN
	
WRITE.TO.CRF:
*---------------
*- Append asset type 
    CHANGE ',' TO ' ' IN CRF.LDS
	BRANCH=RIGHT(CRF.ID,9)
	LINE.NO=FIELD(CRF.REF,'.',2)
	CALL DBR('COMPANY':FM:EB.COM.COMPANY.NAME,BRANCH,BRANCH.NAME)
	CHANGE ',' TO ' ' IN BRANCH.NAME
	OUT.ARR =CRF.ID:DLM:CRF.REF:DLM:LINE.NO:DLM:DQUOTE(CRF.LDS):DLM:CRF.CCY:DLM:ABS(CRF.DR.BAL):DLM:ABS(CRF.CR.BAL):DLM:ABS(CRF.FCY.DR.BAL):DLM:ABS(CRF.FCY.CR.BAL):DLM:YR.MNE:DLM:CRF.TYPE
	OUT.ARR:=DLM:CRF.CAT:DLM:CRF.SEC:DLM:CRF.RES:DLM:CRF.PROD:DLM:CRF.DEPT:DLM:CRF.IND:DLM:BRANCH:DLM:BRANCH.NAME:DLM:REPORT.DATE:DLM:DB.DATE
	PY.LIST<-1>=OUT.ARR
	OUT.ARR='' ; CRF.DR.BAL= 0 ; CRF.CR.BAL= 0 ; CRF.BAL=0 ; TRI.REC='' ; CRF.FCY.DR.BAL=0 ; CRF.FCY.CR.BAL=0 ; CRF.FCY.BAL=0 ; LINE.NO=''
    CRF.BALDAY=0 ; CRF.BALYTD=0 ; CRF.BALMVT=0 ; CRF.FCYBALDAY=0 ; CRF.FCYBALYTD=0 ; CRF.FCYBALMVT=0 ; BRANCH.NAME='' ; BRANCH=''
    RETURN
END
