SUBROUTINE JSL.TOPS.XTR.MONEY.MARKET.M

*============================================
* Title: BI Money Market (MM) Data Extraction
* Initial Author: Yisau Ramon ; For Tops Analytics
* Date: 9th May 2018
*============================================

$INSERT I_COMMON
$INSERT I_EQUATE
$INSERT I_F.MM.MONEY.MARKET
$INSERT I_F.DATES
$INSERT I_F.CATEGORY
$INSERT I_F.COMPANY

GOSUB INIT
GOSUB PROCESS
RETURN

INIT:
    FN.MM='F.MM.MONEY.MARKET'
	F.MM=''
	CALL OPF(FN.MM,F.MM)
    DLM='|'
	CALL GET.LOC.REF('MM.MONEY.MARKET','RTGS.BENF',R.POS)
	CALL GET.LOC.REF('MM.MONEY.MARKET','DEALER.NUMBER',D.POS)
	CALL GET.LOC.REF('MM.MONEY.MARKET','DEALER.NOTES',DN.POS)
	CALL GET.LOC.REF('MM.MONEY.MARKET','MM.TENOR',M.POS)
	OPEN "","/u01/tafj/TAFJ/UD/TOPS.BP" TO F.ACL.CONTIF ELSE PRINT "CAN NOT OPEN DIRECTORY"
	
	REPORT.DATE=R.DATES(EB.DAT.LAST.WORKING.DAY)[1,4]:'-':R.DATES(EB.DAT.LAST.WORKING.DAY)[5,2]:'-':R.DATES(EB.DAT.LAST.WORKING.DAY)[7,2]
    DB.DATE=TODAY[1,4]:'-':TODAY[5,2]:'-':TODAY[7,2]
RETURN

PROCESS:
      MM.CMD='SELECT ':FN.MM:' WITH STATUS NE "LIQ"'
	  CALL EB.READLIST(MM.CMD,MM.LIST,'','','')
	  LOOP
	  REMOVE MM.ID FROM MM.LIST SETTING MM.POS
	  WHILE MM.ID:MM.POS
	  	 CALL F.READ(FN.MM,MM.ID,R.MM,F.MM,MM.ERR) 
		 
		 D.D=R.MM<MM.DEAL.DATE>[1,4]:'-':R.MM<MM.DEAL.DATE>[5,2]:'-':R.MM<MM.DEAL.DATE>[7,2]
		 V.D=R.MM<MM.VALUE.DATE>[1,4]:'-':R.MM<MM.VALUE.DATE>[5,2]:'-':R.MM<MM.VALUE.DATE>[7,2]
		 M.D=R.MM<MM.MATURITY.DATE>[1,4]:'-':R.MM<MM.MATURITY.DATE>[5,2]:'-':R.MM<MM.MATURITY.DATE>[7,2]
		 CALL DBR('CATEGORY':FM:EB.CAT.DESCRIPTION,R.MM<MM.CATEGORY>,CATEGORY.DESC)
		 CALL DBR('DEPT.ACCT.OFFICER':FM:EB.DAO.NAME,R.MM<MM.MIS.ACCT.OFFICER>,OFFICER.NAME)
		 CALL DBR('COMPANY':FM:EB.COM.COMPANY.NAME,R.MM<MM.CO.CODE>,BRANCH.NAME)
		 CHANGE ',' TO ' ' IN CATEGORY.DESC
		 CHANGE ',' TO ' ' IN OFFICER.NAME
                 CHANGE ',' TO ' ' IN BRANCH.NAME
		 OUT.ARR=MM.ID:DLM:R.MM<MM.CUSTOMER.ID>:DLM:R.MM<MM.CURRENCY>:DLM:R.MM<MM.PRINCIPAL>:DLM:D.D:DLM:V.D:DLM:M.D
		 OUT.ARR:=DLM:R.MM<MM.CATEGORY>:DLM:DQUOTE(CATEGORY.DESC):DLM:R.MM<MM.TOT.INTEREST.AMT>:DLM:R.MM<MM.AUTO.ROLLOVER>:DLM:R.MM<MM.DRAWDOWN.ACCOUNT>
		 OUT.ARR:=DLM:R.MM<MM.PRIN.LIQ.ACCT>:DLM:R.MM<MM.INT.LIQ.ACCT>:DLM:R.MM<MM.MIS.ACCT.OFFICER>:DLM:DQUOTE(OFFICER.NAME)
		 OUT.ARR:=DLM:R.MM<MM.STATUS>:DLM:R.MM<MM.TOT.INT.TAX>:DLM:DQUOTE(R.MM<MM.LOCAL.REF,R.POS>)
		 OUT.ARR:=DLM:DQUOTE(R.MM<MM.LOCAL.REF,D.POS>):DLM:DQUOTE(R.MM<MM.LOCAL.REF,DN.POS>):DLM:R.MM<MM.LOCAL.REF,M.POS>
		 OUT.ARR:=DLM:R.MM<MM.CO.CODE>:DLM:BRANCH.NAME:DLM:REPORT.DATE:DLM:DB.DATE
		 
         PY.LIST<-1>=OUT.ARR
		 D.D='' ; M.D='' ; V.D='' ; R.MM='' ; MM.ID='' OUT.ARR=''
	  REPEAT
	  CHANGE '"' TO '' IN PY.LIST
	  WRITE PY.LIST TO F.ACL.CONTIF,'MM.REP.-':DB.DATE:"-.txt"
      RETURN
END