SUBROUTINE JSL.TOPS.XTR.TT.M

*============================================
* Title: BI Teller Data Extraction
* Initial Author: Yisau Ramon ; For Tops Analytics
* Date: 1st May 2018
*============================================

$INSERT I_COMMON
$INSERT I_EQUATE
$INSERT I_F.TELLER
$INSERT I_F.DATES
$INSERT I_F.COMPANY


GOSUB INIT
GOSUB PROCESS
RETURN

INIT:
   FN.TT='F.TELLER$HIS'
   F.TT=''
   CALL OPF(FN.TT,F.TT)
   OPEN "","/u01/tafj/TAFJ/UD/TOPS.BP" TO F.ACL.CONTIF ELSE PRINT "CAN NOT OPEN DIRECTORY"
   LWORK.DATE=R.DATES(EB.DAT.LAST.WORKING.DAY)
   DB.DATE=TODAY[1,4]:'-':TODAY[5,2]:'-':TODAY[7,2] ; OUT.ARR='' ; R.TT='' ; PY.LIST='' ; DLM='|' ; TT.ID='' ; BRANCH.NAME=''
   REPORT.DATE=R.DATES(EB.DAT.LAST.WORKING.DAY)[1,4]:'-':R.DATES(EB.DAT.LAST.WORKING.DAY)[5,2]:'-':R.DATES(EB.DAT.LAST.WORKING.DAY)[7,2]
RETURN

PROCESS:

   TT.CMD='SELECT ':FN.TT:' WITH VALUE.DATE.1 EQ 20180306' ;*:LWORK.DATE
   CALL EB.READLIST(TT.CMD,TT.LIST,'','','')
   LOOP
   REMOVE TT.ID FROM TT.LIST SETTING TT.POS
   WHILE TT.ID:TT.POS
   CALL F.READ(FN.TT,TT.ID,R.TT,F.TT,TT.ERR)
   CALL DBR('COMPANY':FM:EB.COM.COMPANY.NAME,R.TT<TT.TE.CO.CODE>,BRANCH.NAME)
   EX.DATE=R.TT<TT.TE.EXPOSURE.DATE.1>[1,4]:'-':R.TT<TT.TE.EXPOSURE.DATE.1>[5,2]:'-':R.TT<TT.TE.EXPOSURE.DATE.1>[7,2]
   V.DATE1=R.TT<TT.TE.VALUE.DATE.1>[1,4]:'-':R.TT<TT.TE.VALUE.DATE.1>[5,2]:'-':R.TT<TT.TE.VALUE.DATE.1>[7,2]
   V.DATE2=R.TT<TT.TE.VALUE.DATE.2>[1,4]:'-':R.TT<TT.TE.VALUE.DATE.2>[5,2]:'-':R.TT<TT.TE.VALUE.DATE.2>[7,2]
   OUT.ARR=R.TT<TT.TE.TELLER.ID.1>:DLM:R.TT<TT.TE.DR.CR.MARKER>:DLM:R.TT<TT.TE.CURRENCY.1>:DLM:R.TT<TT.TE.ACCOUNT.1>
   OUT.ARR:=DLM:R.TT<TT.TE.CUSTOMER.1>:DLM:R.TT<TT.TE.AMOUNT.LOCAL.1>:DLM:R.TT<TT.TE.AMOUNT.FCY.1>:DLM:V.DATE1
   OUT.ARR:=DLM:EX.DATE:DLM:R.TT<TT.TE.NARRATIVE.1>:DLM:R.TT<TT.TE.CURRENCY.2>:DLM:R.TT<TT.TE.TELLER.ID.2>
   OUT.ARR:=DLM:R.TT<TT.TE.ACCOUNT.2>:DLM:R.TT<TT.TE.CUSTOMER.2>:DLM:R.TT<TT.TE.AMOUNT.LOCAL.2>:DLM:R.TT<TT.TE.AMOUNT.FCY.2>
   OUT.ARR:=DLM:R.TT<TT.TE.NET.AMOUNT>:DLM:V.DATE2:DLM:R.TT<TT.TE.CHEQUE.NUMBER>:DLM:R.TT<TT.TE.CHRG.AMT.LOCAL>
   OUT.ARR:=DLM:R.TT<TT.TE.CHRG.AMT.FCCY>:DLM:R.TT<TT.TE.CO.CODE>:DLM:DQUOTE(BRANCH.NAME):DLM:REPORT.DATE:DLM:DB.DATE
   	PY.LIST<-1>=TRIM(OUT.ARR,",","A")
    TT.ID='' ; R.TT=''; OUT.ARR='' ; BRANCH.NAME='' ; V.DATE1='' ; V.DATE2='' ; EX.DATE=''
	REPEAT
	WRITE PY.LIST TO F.ACL.CONTIF,'TT.REP-':DB.DATE:"-.csv"
    PY.LIST=''
   RETURN
END